pipeline {
  agent any 
  parameters {
    choice( name: 'deployment_env' , choices: ['dev', 'qa', 'prod'], description: 'Select the deployment environment')
  }
  environment {
    TF_DIR = 'tf_infra'
    }

  stages {
    stage ('Clone the Repo') {
        steps {
          git branch: 'main',  url: 'https://github.com/Varsha-hash/Terraform.git'
         } 
        }
       
    stage('Show Selected Environment') {
        steps {
        echo "Deployment environment selected: ${params.deployment_env}"
    }
}

    stage ('terraform init'){
      steps {
       dir("${TF_DIR}") {
          sh """
              terraform init -reconfigure \
              -backend-config="bucket=terraform-state-bucket-varshapat" \
              -backend-config="key=env/${params.deployment_env}/terraform.state" \
              -backend-config="region=ap-south-1"
            """

       }
      }
     }

    stage ("select the workspace" ){
      steps  {
       dir ("${TF_DIR}"){
       sh """
       terraform workspace list 
       terraform workspace select ${params.deployment_env} || terraform workspace new ${params.deployment_env}
       """
       }
      }
     }

    stage ('terraform validate'){
      steps {
       dir("${TF_DIR}") {
       sh 'terraform validate'
       }
      }
    }

    stage ("terraform plan " ){
      steps  {
       dir("${TF_DIR}"){
        sh """
        terraform plan -var-file=config_env/${params.deployment_env}.tfvars -out=tfplan
        """
       }
      }
    }    

    
    stage('Approval') {
      steps {
        input message: "Approve deployment to ${params.deployment_env}?"
         }
        }


    stage ("terraform apply " ){
      steps {
       dir("${TF_DIR}"){
        sh 'terraform apply -auto-approve tfplan'
        }
       }
  }
} 
  
post {
        success {
            echo "Deployment to ${params.deployment_env} successful!"
        }
        failure {
            echo "Deployment failed!"
        }
    }
}